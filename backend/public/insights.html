<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management Reporting - Data Insights Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Chart Components
        const BarChart = ({ data, title, labels, datasets }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets.map(dataset => ({
                            ...dataset,
                            backgroundColor: dataset.backgroundColor || [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(139, 92, 246, 0.8)'
                            ],
                            borderColor: dataset.borderColor || [
                                'rgba(59, 130, 246, 1)',
                                'rgba(16, 185, 129, 1)',
                                'rgba(245, 158, 11, 1)',
                                'rgba(239, 68, 68, 1)',
                                'rgba(139, 92, 246, 1)'
                            ],
                            borderWidth: 2
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: title,
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            },
                            x: {
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            }
                        }
                    }
                });
            }, [data, labels, datasets]);

            return (
                <div className="bg-white rounded-lg shadow p-6">
                    <div className="h-80">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        };

        const LineChart = ({ data, title, labels, datasets }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets.map(dataset => ({
                            ...dataset,
                            borderColor: dataset.borderColor || 'rgba(59, 130, 246, 1)',
                            backgroundColor: dataset.backgroundColor || 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: title,
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            },
                            x: {
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            }
                        }
                    }
                });
            }, [data, labels, datasets]);

            return (
                <div className="bg-white rounded-lg shadow p-6">
                    <div className="h-80">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        };

        const DoughnutChart = ({ data, title, labels, datasets }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: datasets.map(dataset => ({
                            ...dataset,
                            backgroundColor: dataset.backgroundColor || [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(139, 92, 246, 0.8)'
                            ],
                            borderColor: dataset.borderColor || [
                                'rgba(59, 130, 246, 1)',
                                'rgba(16, 185, 129, 1)',
                                'rgba(245, 158, 11, 1)',
                                'rgba(239, 68, 68, 1)',
                                'rgba(139, 92, 246, 1)'
                            ],
                            borderWidth: 2
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: title,
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                display: true,
                                position: 'right'
                            }
                        }
                    }
                });
            }, [data, labels, datasets]);

            return (
                <div className="bg-white rounded-lg shadow p-6">
                    <div className="h-80">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        };

        // Main Dashboard Component
        const DataInsightsDashboard = () => {
            const [insights, setInsights] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('overview');

            // Fetch insights data
            const fetchInsights = async () => {
                try {
                    setLoading(true);
                    
                    // Fetch processed data from different endpoints
                    const [coursesRes, usersRes, skillsRes, exercisesRes, trendsRes] = await Promise.all([
                        axios.get('/api/process/courses'),
                        axios.get('/api/process/users'),
                        axios.get('/api/process/skills'),
                        axios.get('/api/process/exercises'),
                        axios.get('/api/process/trends')
                    ]);

                    // Generate insights from the data
                    const insightsData = {
                        courses: coursesRes.data.data,
                        users: usersRes.data.data,
                        skills: skillsRes.data.data,
                        exercises: exercisesRes.data.data,
                        trends: trendsRes.data.data,
                        timestamp: new Date().toISOString()
                    };

                    setInsights(insightsData);
                } catch (err) {
                    setError('Failed to fetch insights data');
                    console.error('Error fetching insights:', err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchInsights();
            }, []);

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Loading insights...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-red-600 text-xl mb-4">⚠️ {error}</div>
                            <button 
                                onClick={fetchInsights}
                                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                            >
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }

            // Prepare chart data
            const prepareActiveVsRegisteredData = () => {
                const courseData = insights.courses.slice(0, 5); // Top 5 courses
                return {
                    labels: courseData.map(course => course.title),
                    datasets: [{
                        label: 'Registered Users',
                        data: courseData.map(course => course.enrollmentCount)
                    }, {
                        label: 'Active Users',
                        data: courseData.map(course => course.activeUsers)
                    }]
                };
            };

            const prepareCompletionTrendsData = () => {
                const courseData = insights.courses.slice(0, 5);
                return {
                    labels: courseData.map(course => course.title),
                    datasets: [{
                        label: 'Completion Rate (%)',
                        data: courseData.map(course => course.completionRate)
                    }]
                };
            };

            const prepareSkillAcquisitionData = () => {
                const skillLevels = ['beginner', 'intermediate', 'advanced'];
                const skillCounts = skillLevels.map(level => 
                    insights.skills.filter(skill => skill.skillLevel === level).length
                );
                
                return {
                    labels: skillLevels.map(level => level.charAt(0).toUpperCase() + level.slice(1)),
                    datasets: [{
                        data: skillCounts
                    }]
                };
            };

            const prepareExercisePerformanceData = () => {
                const exerciseData = insights.exercises.slice(0, 5);
                return {
                    labels: exerciseData.map(exercise => exercise.title),
                    datasets: [{
                        label: 'Participation Count',
                        data: exerciseData.map(exercise => exercise.participationCount)
                    }, {
                        label: 'Completion Count',
                        data: exerciseData.map(exercise => exercise.completionCount)
                    }]
                };
            };

            const prepareUserEngagementData = () => {
                const engagementLevels = ['Very Active', 'Active', 'Moderate', 'Low', 'Inactive'];
                const userCounts = engagementLevels.map(level => {
                    const daysThreshold = {
                        'Very Active': 1,
                        'Active': 7,
                        'Moderate': 30,
                        'Low': 90,
                        'Inactive': 999
                    };
                    
                    return insights.users.filter(user => {
                        const daysSince = Math.floor((new Date() - new Date(user.lastLogin)) / (1000 * 60 * 60 * 24));
                        return daysSince <= daysThreshold[level];
                    }).length;
                });

                return {
                    labels: engagementLevels,
                    datasets: [{
                        data: userCounts
                    }]
                };
            };

            const preparePerformanceTrendsData = () => {
                const trendData = insights.trends.slice(0, 6);
                return {
                    labels: trendData.map(trend => trend.metric.replace(/_/g, ' ')),
                    datasets: [{
                        label: 'Performance Value',
                        data: trendData.map(trend => trend.value)
                    }]
                };
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-4">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">
                                        Data Insights Dashboard
                                    </h1>
                                    <p className="text-sm text-gray-600">
                                        Advanced Analytics & Visualizations
                                    </p>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <span className="text-sm text-gray-600">
                                        Last updated: {new Date(insights.timestamp).toLocaleString()}
                                    </span>
                                    <button 
                                        onClick={fetchInsights}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                                    >
                                        Refresh Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Navigation Tabs */}
                    <nav className="bg-white border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex space-x-8">
                                {[
                                    { id: 'overview', name: 'Overview' },
                                    { id: 'courses', name: 'Course Analytics' },
                                    { id: 'skills', name: 'Skill Development' },
                                    { id: 'users', name: 'User Engagement' },
                                    { id: 'exercises', name: 'Exercise Performance' },
                                    { id: 'trends', name: 'Performance Trends' }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                            activeTab === tab.id
                                                ? 'border-blue-500 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        {tab.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {/* Overview Tab */}
                        {activeTab === 'overview' && (
                            <div className="space-y-8">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <BarChart
                                        data={prepareActiveVsRegisteredData()}
                                        title="Active vs Registered Users by Course"
                                        labels={prepareActiveVsRegisteredData().labels}
                                        datasets={prepareActiveVsRegisteredData().datasets}
                                    />
                                    <LineChart
                                        data={prepareCompletionTrendsData()}
                                        title="Course Completion Trends"
                                        labels={prepareCompletionTrendsData().labels}
                                        datasets={prepareCompletionTrendsData().datasets}
                                    />
                                </div>
                                
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <DoughnutChart
                                        data={prepareSkillAcquisitionData()}
                                        title="Skill Level Distribution"
                                        labels={prepareSkillAcquisitionData().labels}
                                        datasets={prepareSkillAcquisitionData().datasets}
                                    />
                                    <BarChart
                                        data={prepareUserEngagementData()}
                                        title="User Engagement Levels"
                                        labels={prepareUserEngagementData().labels}
                                        datasets={prepareUserEngagementData().datasets}
                                    />
                                </div>
                            </div>
                        )}

                        {/* Course Analytics Tab */}
                        {activeTab === 'courses' && (
                            <div className="space-y-8">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <BarChart
                                        data={prepareActiveVsRegisteredData()}
                                        title="Course Enrollment vs Activity"
                                        labels={prepareActiveVsRegisteredData().labels}
                                        datasets={prepareActiveVsRegisteredData().datasets}
                                    />
                                    <LineChart
                                        data={prepareCompletionTrendsData()}
                                        title="Completion Rate Trends"
                                        labels={prepareCompletionTrendsData().labels}
                                        datasets={prepareCompletionTrendsData().datasets}
                                    />
                                </div>
                                
                                {/* Course Performance Table */}
                                <div className="bg-white rounded-lg shadow">
                                    <div className="px-6 py-4 border-b border-gray-200">
                                        <h3 className="text-lg font-semibold text-gray-900">Course Performance Details</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Course</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Enrolled</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Active</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Completion Rate</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Activity Rate</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {insights.courses.map(course => (
                                                    <tr key={course.id}>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                            {course.title}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {course.enrollmentCount}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {course.activeUsers}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {course.completionRate}%
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {Math.round((course.activeUsers / course.enrollmentCount) * 100)}%
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Skill Development Tab */}
                        {activeTab === 'skills' && (
                            <div className="space-y-8">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <DoughnutChart
                                        data={prepareSkillAcquisitionData()}
                                        title="Skill Level Distribution"
                                        labels={prepareSkillAcquisitionData().labels}
                                        datasets={prepareSkillAcquisitionData().datasets}
                                    />
                                    <BarChart
                                        data={prepareSkillAcquisitionData()}
                                        title="Skills by Level"
                                        labels={prepareSkillAcquisitionData().labels}
                                        datasets={prepareSkillAcquisitionData().datasets}
                                    />
                                </div>
                            </div>
                        )}

                        {/* User Engagement Tab */}
                        {activeTab === 'users' && (
                            <div className="space-y-8">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <DoughnutChart
                                        data={prepareUserEngagementData()}
                                        title="User Engagement Distribution"
                                        labels={prepareUserEngagementData().labels}
                                        datasets={prepareUserEngagementData().datasets}
                                    />
                                    <BarChart
                                        data={prepareUserEngagementData()}
                                        title="User Activity Levels"
                                        labels={prepareUserEngagementData().labels}
                                        datasets={prepareUserEngagementData().datasets}
                                    />
                                </div>
                            </div>
                        )}

                        {/* Exercise Performance Tab */}
                        {activeTab === 'exercises' && (
                            <div className="space-y-8">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <BarChart
                                        data={prepareExercisePerformanceData()}
                                        title="Exercise Participation vs Completion"
                                        labels={prepareExercisePerformanceData().labels}
                                        datasets={prepareExercisePerformanceData().datasets}
                                    />
                                    <DoughnutChart
                                        data={prepareExercisePerformanceData()}
                                        title="Exercise Completion Rates"
                                        labels={prepareExercisePerformanceData().labels}
                                        datasets={prepareExercisePerformanceData().datasets}
                                    />
                                </div>
                            </div>
                        )}

                        {/* Performance Trends Tab */}
                        {activeTab === 'trends' && (
                            <div className="space-y-8">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <BarChart
                                        data={preparePerformanceTrendsData()}
                                        title="Performance Metrics"
                                        labels={preparePerformanceTrendsData().labels}
                                        datasets={preparePerformanceTrendsData().datasets}
                                    />
                                    <LineChart
                                        data={preparePerformanceTrendsData()}
                                        title="Performance Trends Over Time"
                                        labels={preparePerformanceTrendsData().labels}
                                        datasets={preparePerformanceTrendsData().datasets}
                                    />
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<DataInsightsDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
